---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

/* --- L√ìGICA DEL SERVIDOR --- */
const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

// Cambiado a "/" porque tu login est√° en la ra√≠z, no en /signin
if (!accessToken || !refreshToken) {
  return redirect("/");
}

const { data: { session }, error } = await supabase.auth.setSession({
  access_token: accessToken.value,
  refresh_token: refreshToken.value,
});

if (error || !session) {
  return redirect("/");
}

// Cargar env√≠o previo
const { data: submission } = await supabase
  .from('submissions')
  .select('content_text')
  .eq('session_id', 'week2')
  .eq('user_id', session.user.id)
  .maybeSingle();

const fullText = submission?.content_text || "";
let part1 = "", part2 = "", part3 = "";

if (fullText) {
  const parts = fullText.split(/\[.*?\]/); 
  if (parts.length > 1) part1 = parts[1]?.trim() || "";
  if (parts.length > 2) part2 = parts[2]?.trim() || "";
  if (parts.length > 3) part3 = parts[3]?.trim() || "";
}
---

<Layout title="Woche 2: Tagesablauf und Uhrzeit">
  <div class="container">
    <div class="navbar" style="padding: 0; border: none; margin-bottom: 1rem;">
      <a href="/dashboard" style="color:var(--accent-primary); font-weight:bold; display: flex; align-items: center; gap: 5px;">
        <span>‚Üê</span> Volver al Dashboard
      </a>
    </div>

    <h1>Woche 2: Tagesablauf, Uhrzeit und Wochentage</h1>

    <div class="card" style="border-left: 4px solid var(--accent-primary); background: rgba(46, 249, 158, 0.05);">
      <h3 style="margin-top:0; font-size: 1.1rem;">üìù Instrucciones</h3>
      <p style="font-size: 0.95rem;">Escucha el video y conc√©ntrate en las horas y acciones diarias.</p>
    </div>

    <div class="card" style="margin-bottom: 2rem; text-align:center;">
      <iframe width="100%" height="315" src="https://www.youtube.com/embed/R4tlAm2XPiw" style="max-width:600px;" frameborder="0" allowfullscreen></iframe>
    </div>

    <form id="activity-form" class="card">
      <div style="margin-bottom: 1.5rem;">
        <label>1. Tagesablauf einer Person</label>
        <textarea id="part1" rows="4">{part1}</textarea>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label>2. Dein typischer Tag</label>
        <textarea id="part2" rows="4">{part2}</textarea>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label>3. Reflexi√≥n</label>
        <textarea id="part3" rows="4">{part3}</textarea>
      </div>
      <button type="submit" id="submit-btn" class="btn" style="width:100%;">Absenden</button>
    </form>
  </div>
</Layout>

<script type="module">
    import { supabase } from '../../lib/supabase';
    const form = document.getElementById('activity-form');
    const btn = document.getElementById('submit-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      btn.innerText = "Analizando...";

      const { data: { user } } = await supabase.auth.getUser();
      const text = `[VIDEO]\n${document.getElementById('part1').value}\n\n[MEIN TAG]\n${document.getElementById('part2').value}\n\n[REFLEXION]\n${document.getElementById('part3').value}`;

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const result = await res.json();
        
        await supabase.from('submissions').upsert({
          user_id: user.id,
          user_email: user.email,
          session_id: 'week2',
          content_text: text,
          ai_feedback: result.feedback
        }, { onConflict: 'user_id,session_id' });

        window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;
      } catch (err) {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Reintentar";
      }
    });
</script>
