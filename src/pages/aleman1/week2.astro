---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

const { cookies, redirect } = Astro;
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/");
}

const { data: { session } } = await supabase.auth.setSession({
  access_token: accessToken.value,
  refresh_token: refreshToken.value,
});

if (!session) return redirect("/");

const { data: submission } = await supabase
  .from('submissions')
  .select('content_text')
  .eq('session_id', 'a1-w2')
  .eq('user_id', session.user.id)
  .maybeSingle();

const fullText = submission?.content_text || "";
let part1 = "", part2 = "", part3 = "";

if (fullText) {
  const parts = fullText.split(/\[.*?\]/); 
  if (parts.length > 1) part1 = parts[1]?.trim() || "";
  if (parts.length > 2) part2 = parts[2]?.trim() || "";
  if (parts.length > 3) part3 = parts[3]?.trim() || "";
}
---

<Layout title="W-Fragen und Zahlen">
  <div class="container">
    <div class="navbar" style="padding: 0; border: none; margin-bottom: 1rem;">
      <a href="/dashboard" style="color:var(--accent-primary); font-weight:bold;">← Dashboard</a>
    </div>

    <h1>Woche 2: W-Fragen und Zahlen</h1>

    <div class="card" style="margin-bottom: 2rem; text-align:center;">
      <iframe width="100%" height="315" src="https://www.youtube.com/embed/Yaelm87PTvg" style="max-width:600px;" frameborder="0" allowfullscreen></iframe>
    </div>

    <form id="activity-form" class="card">
      <div style="margin-bottom: 1.5rem;">
        <label>1. Tu presentación personal</label>
        <textarea id="part1" rows="3">{part1}</textarea>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label>2. Persona del video</label>
        <textarea id="part2" rows="3">{part2}</textarea>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label>3. Reflexión</label>
        <textarea id="part3" rows="4">{part3}</textarea>
      </div>
      <button type="submit" id="submit-btn" class="btn" style="width:100%;">Enviar</button>
    </form>
  </div>
</Layout>

<script type="module">
    import { supabase } from '../../lib/supabase';
    const form = document.getElementById('activity-form');
    const btn = document.getElementById('submit-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      btn.innerText = "Procesando...";

      const { data: { user } } = await supabase.auth.getUser();
      const text = `[PRESENTACIÓN]\n${document.getElementById('part1').value}\n\n[PERSONAJE]\n${document.getElementById('part2').value}\n\n[REFLEXIÓN]\n${document.getElementById('part3').value}`;

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const result = await res.json();
        
        await supabase.from('submissions').upsert({
          user_id: user.id,
          user_email: user.email,
          session_id: 'a1-w2',
          content_text: text,
          ai_feedback: result.feedback
        }, { onConflict: 'user_id,session_id' });

        window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;
      } catch (err) {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Reintentar";
      }
    });
</script>
