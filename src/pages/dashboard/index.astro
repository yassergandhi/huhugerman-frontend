---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { COURSE_CONFIG } from '../../lib/roadmap';
import CourseList from '../../components/CourseList.astro';

// 1. ProtecciÃ³n de Ruta (Server Side)
const { cookies, redirect } = Astro;
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/");
}

// 2. Obtener SesiÃ³n y Datos
let session;
try {
  const { data, error } = await supabase.auth.setSession({
    access_token: accessToken.value,
    refresh_token: refreshToken.value,
  });
  if (error) throw error;
  session = data.session;
} catch (error) {
  cookies.delete("sb-access-token", { path: "/" });
  cookies.delete("sb-refresh-token", { path: "/" });
  return redirect("/");
}

// 3. Obtener Perfil (Nivel del usuario)
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', session?.user?.id)
  .single();

// Nivel por defecto si falla la DB
const userLevel = profile?.assigned_level?.replace('-', '') || 'aleman1'; // Limpieza 'aleman-1' -> 'aleman1'

// 4. Obtener Historial (Opcional, para mostrar abajo)
const { data: submissions } = await supabase
  .from('submissions')
  .select('*')
  .eq('user_id', session?.user?.id)
  .order('created_at', { ascending: false })
  .limit(5);

const email = session?.user?.email;
---

<Layout title="Dashboard | Huhugerman">
  <main class="container">
    
    <div style="margin-bottom: 3rem; border-bottom: 1px solid var(--border-color); padding-bottom: 2rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--text-primary);">
        Hola, <span style="color: var(--accent-primary);">{email?.split('@')[0]}</span> ðŸ‘‹
      </h1>
      <p style="color: var(--text-secondary);">
        Nivel Actual: <strong style="text-transform: uppercase; color: var(--text-primary);">{userLevel}</strong>
      </p>
    </div>

    <CourseList levelId={userLevel} />

    {submissions && submissions.length > 0 && (
      <div style="margin-top: 5rem;">
        <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
          <span>ðŸ“œ</span> Historial Reciente
        </h2>
        
        <div class="grid">
          {submissions.map((sub) => (
            <div class="card" style="padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <span class="status-badge" style="font-size: 0.7rem;">{sub.session_id || 'PrÃ¡ctica'}</span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">
                  {new Date(sub.created_at).toLocaleDateString()}
                </span>
              </div>
              <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 0;">
                {sub.content_text?.substring(0, 80)}...
              </p>
            </div>
          ))}
        </div>
      </div>
    )}

  </main>
</Layout>
