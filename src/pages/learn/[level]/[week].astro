---
// src/pages/learn/[level]/[week].astro
import Layout from '@/layouts/Layout.astro';
import GuidedActivity from '@/components/GuidedActivity.astro';

// 1. Obtener parámetros
const { level, week } = Astro.params;

// 2. Validación de seguridad y existencia de parámetros
if (!level || !week) return Astro.redirect('/404');

// 3. Normalización: /week1 -> /w01
const weekMatch = week.match(/^week(\d+)$/i);
if (weekMatch) {
  const weekNum = weekMatch[1].padStart(2, '0');
  return Astro.redirect(`/learn/${level}/w${weekNum}`);
}

// 4. Validación de niveles permitidos (Prevenir inyecciones de ruta)
const allowedLevels = ['aleman1', 'aleman2'];
if (!allowedLevels.includes(level)) return Astro.redirect('/404');

let lesson: any = null;

try {
  /* Vite necesita una pista sobre la carpeta. 
     Usar una ruta semi-estática es más robusto para el bundling.
  */
  const lessonModule = await import(`../../../lib/courses/${level}/sessions/${week}.js`);
  lesson = lessonModule.default || lessonModule;

  // Inyección de contexto para componentes hijos
  lesson.level = level;
  lesson.weekId = week;
  lesson.slug = week; // Aseguramos que tenga el slug para el formulario

} catch (error) {
  console.error(`❌ Error cargando: ${level}/${week}`);
  return Astro.redirect('/404');
}

// 5. Verificación de integridad
if (!lesson || !lesson.title) {
  return Astro.redirect('/404');
}
---

<Layout title={lesson.title}>
  {/* Usamos la lógica de 'guided' para mostrar el componente que maneja 
      el formulario y la persistencia que acabamos de blindar.
  */}
  {lesson.type === 'guided' || lesson.activity ? (
    <GuidedActivity lesson={lesson} />
  ) : (
    <div class="container">
      <h1>{lesson.title}</h1>
      <p>Esta lección aún no tiene una actividad configurada.</p>
    </div>
  )}
</Layout>