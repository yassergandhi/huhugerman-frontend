---
// src/pages/learn/[level]/[week].astro
import Layout from '@/layouts/Layout.astro';
import GuidedActivity from '@/components/GuidedActivity.astro';
import LessonUI from '@/components/LessonUI.astro'; // Asegúrate de tener este componente o quitar la referencia si no lo usas

// 1. Obtener parámetros de la URL
const { level, week } = Astro.params;

// 2. Validación de seguridad básica
if (!level || !week) {
  return Astro.redirect('/404');
}

// 3. Normalización de URL (Auto-corrección de 'week1' a 'w01')
// Si el usuario entra a /week1, lo mandamos a /w01 para que coincida con tu archivo w01.js
const weekMatch = week.match(/^week(\d+)$/i);
if (weekMatch) {
  const weekNum = weekMatch[1].padStart(2, '0'); // 1 -> 01
  return Astro.redirect(`/learn/${level}/w${weekNum}`);
}

let lesson = null;

try {
  // 4. Importación Dinámica (Ruta relativa basada en tu TREE)
  // Estás en: src/pages/learn/[level]/[week].astro
  // Los cursos están en: src/lib/courses/[level]/sessions/[week].js
  // Ruta relativa: ../../../lib/courses/...
  
  const lessonModule = await import(`../../../lib/courses/${level}/sessions/${week}.js`);
  
  // Soporte para export default o module.exports
  lesson = lessonModule.default || lessonModule;

  // Inyectamos IDs para que los componentes hijos sepan el contexto
  lesson.level = level;
  lesson.weekId = week;

} catch (error) {
  console.error(`❌ [Error de Carga] No se encontró la lección: ${level}/${week}`);
  console.error(`   Intentado en ruta: ../../../lib/courses/${level}/sessions/${week}.js`);
  
  // Si el archivo no existe, NO crasheamos. Redirigimos a 404.
  return Astro.redirect('/404');
}

// 5. Verificación final de integridad
if (!lesson || !lesson.title) {
  console.error("❌ La lección cargó pero le falta el título o datos esenciales.");
  return Astro.redirect('/404');
}
---

<Layout title={lesson.title}>
  {lesson.type === 'guided' || lesson.activity ? (
    <GuidedActivity lesson={lesson} />
  ) : (
    /* Fallback para lecciones puramente de contenido si existen */
    <LessonUI lesson={lesson} />
  )}
</Layout>