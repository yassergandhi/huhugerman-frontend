---
// src/components/GuidedActivity.astro
import { getBackLink } from '@lib/navigation';

// Aseguramos tipado b√°sico para las props
const { lesson } = Astro.props;
const backLink = getBackLink(lesson);

// Fallback seguro para el ID de la semana y nivel si no vienen expl√≠citos
const weekId = lesson.weekId || lesson.id || 'w01'; 
const levelId = lesson.level || 'aleman1';
---

<div class="container">
  <div class="navbar" style="padding:0; border:none; margin-bottom:1rem;">
    <a
      href={backLink.href}
      style="color:var(--accent-primary); font-weight:bold; display:flex; align-items:center; gap:5px;"
    >
      <span>‚Üê</span> {backLink.label}
    </a>
  </div>

  <h1>{lesson.title}</h1>

  <div class="card activity-notice">
    <h3>‚ÑπÔ∏è Actividad formativa</h3>
    <p>
      Tu entrega es lo que cuenta. El feedback te ayuda a mejorar y la entrega se traduce despu√©s en la calificaci√≥n institucional.
    </p>
  </div>

  <div class="card">
    <h3>üìù Instrucciones de la Actividad</h3>
    <p>{lesson.instructions.intro}</p>
    <ul>
      {lesson.instructions.grammarReminder.map((item: string) => (
        <li>{item}</li>
      ))}
    </ul>
  </div>

  {lesson.source?.type === 'youtube' && (
    <div class="card" style="padding:0; overflow:hidden;">
      <div style="position:relative; padding-bottom:56.25%;">
        <iframe
          src={lesson.source.embedUrl}
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
          allowfullscreen
        />
      </div>
    </div>
  )}

  <form id="activity-form" data-level={levelId} data-week={weekId}>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
      <div>
        <label for="firstName" style="display:block; font-weight:bold; margin-bottom:0.5rem;">Nombre(s)*</label>
        <input 
          type="text" 
          id="firstName" 
          name="firstName" 
          required
          placeholder="Ej. Juan"
          style="width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:8px;"
        />
      </div>
      <div>
        <label for="lastName" style="display:block; font-weight:bold; margin-bottom:0.5rem;">Apellido(s)*</label>
        <input 
          type="text" 
          id="lastName" 
          name="lastName" 
          required
          placeholder="Ej. P√©rez"
          style="width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:8px;"
        />
      </div>
    </div>

    <h2>{lesson.activity.title}</h2>
    
    {lesson.activity.parts.map((part: any, index: number) => (
      <div style="margin-bottom:1.5rem;">
        <label for={part.id} class="activity-label">{part.label}</label>
        <p style="font-size:0.8rem; opacity:.7;">{part.help}</p>
        <textarea
          id={part.id}
          name={part.id}
          data-label={part.label} 
          rows={part.rows || 4}
          placeholder={part.placeholder}
          required
          style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-family: inherit;"
        />
      </div>
    ))}

    <button type="submit" id="submit-btn" class="btn" style="width:100%;">
      Enviar respuestas
    </button>
  </form>

  <div
    id="feedback-container"
    class="card"
    style="display:none; margin-top:2rem; border-left:4px solid var(--accent-secondary);"
  >
    <h3 style="margin-top:0;">üìò Feedback del Profesor</h3>
    <div id="feedback-content"></div>
    
    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color);">
      <p style="font-weight: bold; color: var(--accent-primary); display: flex; align-items: center; gap: 0.5rem;">
        ‚úÖ <span>Actividad entregada</span>
      </p>
      <p style="font-size: 0.85rem; opacity: 0.8;">
        Tu respuesta ha sido registrada correctamente en el sistema.
      </p>
    </div>
  </div>
</div>

<script>
  // Script del Cliente
  const form = document.getElementById('activity-form') as HTMLFormElement;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const feedbackContainer = document.getElementById('feedback-container');
  const feedbackContent = document.getElementById('feedback-content');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // 1. Obtener datos b√°sicos
      const firstNameInput = document.getElementById('firstName') as HTMLInputElement;
      const lastNameInput = document.getElementById('lastName') as HTMLInputElement;
      
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const level = form.dataset.level; // Le√≠do desde el HTML
      const week = form.dataset.week;   // Le√≠do desde el HTML

      // Validaci√≥n simple
      if (firstName.length < 2 || lastName.length < 2) {
        alert('‚ö†Ô∏è Por favor ingresa tu nombre y apellido completos.');
        return;
      }

      // 2. Recolecci√≥n din√°mica del contenido (independiente del n√∫mero de partes)
      let content = "";
      const textareas = form.querySelectorAll('textarea');
      let hasContent = false;

      textareas.forEach((area) => {
        const value = (area as HTMLTextAreaElement).value.trim();
        if (value) {
          hasContent = true;
          // Usamos el label del atributo data, o el ID como fallback
          const label = area.getAttribute('data-label') || area.id.toUpperCase();
          content += `[${label}]\n${value}\n\n`;
        }
      });

      if (!hasContent) {
        alert('‚ö†Ô∏è Escribe al menos una respuesta antes de enviar.');
        return;
      }

      btn.disabled = true;
      btn.innerText = 'Enviando...';

      // 3. Construcci√≥n del Payload (Coincide con SubmissionInputSchema)
      const payload = {
        firstName,
        lastName,
        level,   // Ej: 'aleman1'
        week,    // Ej: 'w01'
        content: content.trim(),
        email: "" // Opcional por ahora
      };

      try {
        const response = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (!response.ok || (result.error)) {
          throw new Error(result.error || 'Error en el servidor');
        }
        
        // 4. Mostrar Feedback
        if (feedbackContent && feedbackContainer) {
          feedbackContent.innerHTML = result.feedback || "Respuesta registrada.";
          feedbackContainer.style.display = 'block';
          feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
      } catch (err: any) {
        console.error('Error:', err);
        alert(`‚ùå Error: ${err.message || 'No se pudo enviar la actividad'}`);
      } finally {
        btn.disabled = false;
        btn.innerText = 'Enviar respuestas';
      }
    });
  }
</script>